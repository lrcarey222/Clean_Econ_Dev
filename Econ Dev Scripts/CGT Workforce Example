##############################################################################
# CGT Workforce
##############################################################################

# 1. Set working directory
setwd("~/Library/CloudStorage/OneDrive-RMI/")

# 2. Load Latest Clean Growth Tool Data
cgt <- readRDS(
  "~/Library/CloudStorage/OneDrive-RMI/US Program - Documents/6_Projects/Clean Regional Economic Development/ACRE/Data/Clean-growth-project/clean_growth_toolkit_data/acre_tool_final_data.rds"
)

# 3. Extract relevant tables
msa_data        <- cgt$msa_data
naics_msa_data  <- cgt$naics_msa_data
naics_data      <- cgt$naics_data
states_msa      <- cgt$states_msa
naics6d_data    <- cgt$naics6d_data
transition      <- cgt$transition_sector_data
soc_msa_data    <- cgt$soc_msa_data
naics_soc_data  <- cgt$naics_soc_data
soc_data        <- cgt$soc_data

# 4. Glimpse each table
cat("Glimpsing msa_data\n")
glimpse(msa_data)

cat("Glimpsing naics_msa_data\n")
glimpse(naics_msa_data)

cat("Glimpsing naics_data\n")
glimpse(naics_data)

cat("Glimpsing states_msa\n")
glimpse(states_msa)

cat("Glimpsing naics6d_data\n")
glimpse(naics6d_data)

cat("Glimpsing transition\n")
glimpse(transition)

cat("Glimpsing soc_msa_data\n")
glimpse(soc_msa_data)

# 5. Filter soc_msa_data for Salt Lake City (MSA == "41620")
cat("Filtering SOC MSA data for Salt Lake City\n")
soc_msa_data_saltlake <- soc_msa_data %>%
  filter(msa == "41620")

cat("Filtered SOC MSA data for Salt Lake City\n")
glimpse(soc_msa_data_saltlake)

# 6. Glimpse naics_soc_data and soc_data
cat("Glimpsing naics_soc_data\n")
glimpse(naics_soc_data)

cat("Glimpsing soc_data\n")
glimpse(soc_data)

# 7. Filter naics_msa_data for Salt Lake City MSA
cat("Filtering NAICS MSA data for Salt Lake City MSA\n")
naics_msa_data_saltlake <- naics_msa_data %>%
  filter(msa == "41620")

cat("Filtered NAICS MSA data for Salt Lake City\n")
glimpse(naics_msa_data_saltlake)

##############################################################################
# Batteries & Components Workforce Analysis
##############################################################################

# ---- IMPORTANT: Use the actual 6-digit codes that represent battery manufacturing ----
# Example battery NAICS codes (verify these with your domain knowledge):
battery_6d_codes <- c(335911, 335912, 335913)  

# Filter naics_soc_data for those battery NAICS codes at the 6-digit level.
cat("Filtering naics_soc_data for known battery NAICS codes...\n")
batteries_naics_soc <- naics_soc_data %>%
  filter(
    aggregation_level == 6,       # ensures 6-digit detail
    naics %in% battery_6d_codes
  )

cat("Glimpsing filtered batteries_naics_soc...\n")
glimpse(batteries_naics_soc)

# Join to get (1) the SOC title from soc_data and (2) the Salt Lake City RCA from soc_msa_data_saltlake
cat("Building final Batteries & Components workforce table for Salt Lake City...\n")
batteries_soc_slc <- batteries_naics_soc %>%
  distinct(soc) %>%
  left_join(
    soc_data %>% select(soc, soc_title),
    by = "soc"
  ) %>%
  left_join(
    soc_msa_data_saltlake %>% select(soc, rca),
    by = "soc"
  ) %>%
  select(soc, soc_title, rca)

cat("Final table: Batteries & Components workforce (Salt Lake City MSA):\n")
glimpse(batteries_soc_slc)

##############################################################################
# (Optional) Source another script if you wish
##############################################################################
# source("~/Documents/CGT_R_notes/scripts/CGT Workforce.R")
